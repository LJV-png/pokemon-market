name: Update Pokémon Market Index

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'   # every hour

jobs:
  update_index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pandas

      - name: Generate simulated market data
        run: |
          python <<EOF
          import pandas as pd
          from datetime import datetime
          import random
          import os

          CSV_PATH = "docs/market.csv"

          # Simulated "real" cards (acts like eBay averages)
          cards = {
              "Charizard Base Set PSA 10": 4200,
              "Pikachu Base Set PSA 10": 1800,
              "Umbreon VMAX Alt Art": 950,
              "Rayquaza Gold Star": 3200,
              "Blastoise Base Set PSA 10": 2600
          }

          # Small realistic market movements
          prices = []
          for base in cards.values():
              change = random.uniform(-0.015, 0.015)  # ±1.5%
              prices.append(base * (1 + change))

          index_value = round(sum(prices) / len(prices), 2)
          timestamp = datetime.utcnow().strftime("%Y-%m-%d %H:%M")

          if os.path.exists(CSV_PATH):
              df = pd.read_csv(CSV_PATH)
          else:
              df = pd.DataFrame(columns=["datetime", "index"])

          df.loc[len(df)] = [timestamp, index_value]
          df.to_csv(CSV_PATH, index=False)
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/market.csv
          git commit -m "Hourly market index update" || echo "No changes"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
