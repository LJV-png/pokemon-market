name: Update Pokémon Market Index

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # hourly

jobs:
  update_csv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas requests

      - name: Fetch eBay Data & Update CSV
        env:
          EBAY_CLIENT_ID: ${{ secrets.EBAY_CLIENT_ID }}
          EBAY_CLIENT_SECRET: ${{ secrets.EBAY_CLIENT_SECRET }}
        run: |
          python << 'EOF'
          import base64, requests, os, pandas as pd, statistics
          from datetime import date

          csv_path = "docs/market.csv"
          os.makedirs("docs", exist_ok=True)

          # Get token
          cid = os.environ["EBAY_CLIENT_ID"]
          secret = os.environ["EBAY_CLIENT_SECRET"]
          auth = base64.b64encode(f"{cid}:{secret}".encode()).decode()
          token_res = requests.post(
              "https://api.ebay.com/identity/v1/oauth2/token",
              headers={
                  "Authorization": f"Basic {auth}",
                  "Content-Type": "application/x-www-form-urlencoded"
              },
              data={
                  "grant_type": "client_credentials",
                  "scope": "https://api.ebay.com/oauth/api_scope"
              }
          )
          token_res.raise_for_status()
          token = token_res.json()["access_token"]

          # Search Pokémon cards (example: 50 listings)
          search = requests.get(
              "https://api.ebay.com/buy/browse/v1/item_summary/search",
              headers={"Authorization": f"Bearer {token}"},
              params={
                  "q": "pokemon card",
                  "category_ids": "183454",
                  "limit": 50
              }
          )
          search.raise_for_status()
          items = search.json().get("itemSummaries", [])

          # Compute median price
          prices = [float(i["price"]["value"]) for i in items if "price" in i]
          median_price = statistics.median(prices) if prices else 100

          # Append to CSV
          if os.path.exists(csv_path):
              df = pd.read_csv(csv_path)
          else:
              df = pd.DataFrame(columns=["date", "index"])

          today = date.today().isoformat()
          df.loc[len(df)] = [today, median_price]
          df.to_csv(csv_path, index=False)
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/market.csv
          git commit -m "Automated market update" || echo "No changes"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
