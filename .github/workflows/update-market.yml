name: Update Pokémon Market Index

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # every day at UTC midnight

jobs:
  update_csv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas requests

      - name: Update market.csv
        env:
          EBAY_TOKEN: ${{ secrets.EBAY_TOKEN }}
        run: |
          python <<EOF
          import pandas as pd
          import requests
          from datetime import date

          # -------------------------
          # CONFIG
          # -------------------------
          CSV_PATH = "docs/market.csv"
          EBAY_TOKEN = "${{ secrets.EBAY_TOKEN }}"
          BASE_URL = "https://api.ebay.com/buy/browse/v1/item_summary/search"

          # Define a basket of representative Pokémon cards (examples)
          BASKET = [
              "Charizard", "Pikachu", "Blastoise", "Mewtwo", "Venusaur"
          ]

          headers = {
              "Authorization": f"Bearer {EBAY_TOKEN}",
              "Content-Type": "application/json"
          }

          # -------------------------
          # Fetch latest sold listings
          # -------------------------
          all_prices = []
          all_volumes = []

          for card in BASKET:
              params = {
                  "q": card + " Pokemon",
                  "filter": "itemLocationCountry:US,sold:true",
                  "limit": "50"
              }
              try:
                  resp = requests.get(BASE_URL, headers=headers, params=params)
                  resp.raise_for_status()
                  data = resp.json().get("itemSummaries", [])
                  prices = [float(item["price"]["value"]) for item in data if "price" in item]
                  volume = len(prices)
                  if volume > 0:
                      avg_price = sum(prices) / volume
                      all_prices.append(avg_price)
                      all_volumes.append(volume)
              except Exception as e:
                  print(f"Error fetching {card}: {e}")

          # -------------------------
          # Compute weighted index
          # -------------------------
          if all_prices and all_volumes:
              total_volume = sum(all_volumes)
              weights = [v / total_volume for v in all_volumes]
              weighted_avg = sum(p * w for p, w in zip(all_prices, weights))
          else:
              # fallback if no data
              weighted_avg = 100

          # -------------------------
          # Append to CSV
          # -------------------------
          today = date.today().isoformat()
          try:
              df = pd.read_csv(CSV_PATH)
          except:
              df = pd.DataFrame(columns=["date", "index"])

          df.loc[len(df)] = [today, round(weighted_avg, 2)]
          df.to_csv(CSV_PATH, index=False)
          print(f"Added {today}: {round(weighted_avg,2)}")
          EOF

      - name: Commit & Push
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/market.csv
          git commit -m "Daily automated Pokémon Market Index update" || echo "No changes"
          git push https://x-access-token:${{GH_TOKEN}}@github.com/${{ github.repository }} HEAD:main
