name: Update Pokémon Market Index

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # every hour

jobs:
  update_index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas requests

      - name: Update market.csv
        env:
          EBAY_TOKEN: ${{ secrets.EBAY_TOKEN }}
        run: |
          python <<EOF
          import pandas as pd
          import requests
          from datetime import datetime
          import os, random

          csv_path = "docs/market.csv"
          os.makedirs("docs", exist_ok=True)

          # Fetch actual prices from eBay API
          headers = {"Authorization": f"Bearer {os.environ['EBAY_TOKEN']}"}
          try:
              resp = requests.get(
                  "https://api.ebay.com/buy/browse/v1/item_summary/search?q=pokemon+card&limit=50",
                  headers=headers
              )
              data = resp.json()
              prices = [item["price"]["value"] for item in data.get("itemSummaries", []) if "price" in item]
              transactions = [item.get("buyingOptions", ["UNKNOWN"])[0] for item in data.get("itemSummaries", [])]  # crude proxy
          except Exception:
              # fallback to mock data if API fails
              prices = [random.uniform(1, 200) for _ in range(50)]
              transactions = [random.randint(0,5) for _ in range(50)]

          # Calculate index: average price * number of transactions
          avg_price = sum(prices) / len(prices) if prices else 100
          num_transactions = sum(transactions) if transactions else len(prices)
          index_value = avg_price * num_transactions / 100  # scale to a readable number

          # Load previous CSV or create new
          if os.path.exists(csv_path):
              df = pd.read_csv(csv_path)
          else:
              df = pd.DataFrame(columns=["timestamp","index_value","transactions"])

          # Append new row
          now = datetime.utcnow().isoformat()
          df.loc[len(df)] = [now, round(index_value,2), num_transactions]

          # Save CSV
          df.to_csv(csv_path, index=False)
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/market.csv
          git commit -m "Update Pokémon Market Index" || echo "No changes"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
